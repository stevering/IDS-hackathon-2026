# SpÃ©cifications - Construction des URLs MCP (Figma & Code Editor)

## Vue d'ensemble

Ce document dÃ©crit le fonctionnement complet de la construction des URLs pour accÃ©der aux serveurs MCP (Model Context Protocol) de Figma et du Code Editor, en environnement de dÃ©veloppement et de production, avec et sans proxy.

---

## 1. Variables d'environnement

### Variables utilisÃ©es

| Variable | Description | Exemple |
|----------|-------------|---------|
| `NODE_ENV` | Mode d'exÃ©cution | `development` / `production` |
| `NEXT_PUBLIC_LOCAL_MCP_FIGMA_URL` | URL directe du MCP Figma local | `http://127.0.0.1:3845/mcp` |
| `NEXT_PUBLIC_LOCAL_MCP_CODE_URL` | URL directe du MCP Code local | `http://127.0.0.1:3846/mcp` |
| `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` | URL proxy pour Figma | `http://localhost:3000/proxy-local/figma/mcp` |
| `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP` | URL proxy pour Code | `http://localhost:3000/proxy-local/code/mcp` |
| `NEXT_PUBLIC_MCP_TUNNEL_SECRET` | Secret d'authentification tunnel | Token gÃ©nÃ©rÃ© alÃ©atoirement |
| `NEXT_PUBLIC_BASE_URL` | URL de base de l'application | `http://127.0.0.1:3000` |
| `FIGMA_ACCESS_TOKEN` | Token d'accÃ¨s Figma (optionnel) | `figd_xxxxx` |
| `FIGMA_CLIENT_ID` | Client ID OAuth Figma (optionnel) | `xxxxx` |
| `FIGMA_CLIENT_SECRET` | Client Secret OAuth Figma (optionnel) | `xxxxx` |

---

## 2. Architecture des flux de connexion

### 2.1 Mode DÃ©veloppement - Direct (sans proxy)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MODE DÃ‰VELOPPEMENT - DIRECT (SANS PROXY)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Figma Server   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚    (port 3845)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  1. POST /api/chat     â”‚                            â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚  Headers:              â”‚                            â”‚
       â”‚  X-Auth-Token: secret  â”‚                            â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                            â”‚
       â”‚    http://127.0.0.1:   â”‚                            â”‚
       â”‚    3845/mcp            â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚    to: 127.0.0.1:3845/mcp  â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
       â”‚                        â”‚                            â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Code Server    â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚    (port 3846)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  Headers:              â”‚                            â”‚
       â”‚  X-Auth-Token: secret  â”‚                            â”‚
       â”‚  X-MCP-Code-URL:       â”‚                            â”‚
       â”‚    http://127.0.0.1:   â”‚                            â”‚
       â”‚    3846/mcp            â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚    to: 127.0.0.1:3846/mcp  â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
```

**CaractÃ©ristiques:**
- Connexion directe du serveur Next.js aux MCP locaux
- URLs utilisÃ©es: `NEXT_PUBLIC_LOCAL_MCP_FIGMA_URL` et `NEXT_PUBLIC_LOCAL_MCP_CODE_URL`
- Authentification via `X-Auth-Token` header
- Les URLs sont passÃ©es via les headers `X-MCP-Figma-URL` et `X-MCP-Code-URL`

---

### 2.2 Mode DÃ©veloppement - Proxy Local

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MODE DÃ‰VELOPPEMENT - PROXY LOCAL                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Figma  â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3845)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  1. POST /api/chat     â”‚                        â”‚                        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  figmaMcpUrl:          â”‚                        â”‚                        â”‚
       â”‚    http://localhost:   â”‚                        â”‚                        â”‚
       â”‚    3000/proxy-local/   â”‚                        â”‚                        â”‚
       â”‚    figma/mcp           â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3845/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET /proxy-local/  â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    figma/mcp           â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3845  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Figma-   â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  4. Response           â”‚
       â”‚                        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  5. Modified response  â”‚                        â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚
       â”‚                        â”‚    (URLs remapped)     â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  6. Stream to client   â”‚                        â”‚                        â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚                        â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Code   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3846)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  codeProjectPath:      â”‚                        â”‚                        â”‚
       â”‚    http://localhost:   â”‚                        â”‚                        â”‚
       â”‚    3000/proxy-local/   â”‚                        â”‚                        â”‚
       â”‚    code/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Code-URL:       â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3846/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET /proxy-local/  â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    code/mcp            â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3846  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Code-    â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  4. Response           â”‚
       â”‚                        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  5. SSE stream         â”‚                        â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚
       â”‚                        â”‚    (URLs remapped)     â”‚                        â”‚
```

**CaractÃ©ristiques:**
- Le middleware proxy (`src/proxy.ts`) intercepte les requÃªtes `/proxy-local/*`
- Pour Figma: utilise les rewrites Next.js dÃ©finis dans `next.config.ts`
- Pour Code: utilise le middleware personnalisÃ© qui gÃ¨re aussi la remapping des URLs dans les rÃ©ponses SSE
- URLs utilisÃ©es: `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` et `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP`
- Le header `X-MCP-Code-URL` est utilisÃ© par le proxy pour dÃ©terminer l'URL cible:
  - Exemple: si `X-MCP-Code-URL: http://127.0.0.1:3846/mcp`, le proxy forward vers `http://127.0.0.1:3846/mcp`
  - Si l'URL ne se termine pas par `/mcp` ou `/sse` (ex: `/mcp3`), le proxy forward vers l'URL exacte sans ajouter de path
  - Si pas de header, utilise `NEXT_PUBLIC_LOCAL_MCP_CODE_URL` depuis les variables d'environnement

---

### 2.3 Mode DÃ©veloppement - Proxy Online (Tunnel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODE DÃ‰VELOPPEMENT - PROXY ONLINE (TUNNEL)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Figma  â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3845)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  1. POST /api/chat     â”‚                        â”‚                        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  figmaMcpUrl:          â”‚                        â”‚                        â”‚
       â”‚    https://tunnel.     â”‚                        â”‚                        â”‚
       â”‚    trycloudflare.com/  â”‚                        â”‚                        â”‚
       â”‚    proxy-local/        â”‚                        â”‚                        â”‚
       â”‚    figma/mcp           â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3845/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET https://tunnel â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    .trycloudflare.com/ â”‚                        â”‚
       â”‚                        â”‚    proxy-local/figma/  â”‚                        â”‚
       â”‚                        â”‚    mcp                 â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3845  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Figma-   â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Code   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3846)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  codeProjectPath:      â”‚                        â”‚                        â”‚
       â”‚    https://tunnel.     â”‚                        â”‚                        â”‚
       â”‚    trycloudflare.com/  â”‚                        â”‚                        â”‚
       â”‚    proxy-local/code/   â”‚                        â”‚                        â”‚
       â”‚    mcp                 â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Code-URL:       â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3846/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET https://tunnel â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    .trycloudflare.com/ â”‚                        â”‚
       â”‚                        â”‚    proxy-local/code/   â”‚                        â”‚
       â”‚                        â”‚    mcp                 â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3846  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Code-    â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
```

**CaractÃ©ristiques:**
- Utilise un tunnel Cloudflare (ou similaire) pour exposer le proxy local
- Le browser se connecte au tunnel, qui forward vers le proxy local
- Le proxy local utilise les headers `X-MCP-*-URL` pour forwarder vers les MCP locaux
- Les deux modes (Proxy Online et Proxy Local) peuvent Ãªtre actifs simultanÃ©ment
- URLs utilisÃ©es: `{tunnel}/proxy-local/figma/mcp` et `{tunnel}/proxy-local/code/mcp`

---

### 2.4 Mode Production

En production, l'application est dÃ©ployÃ©e sur une URL distante (ex: `https://ids-hackathon-2026-ds-ai-guardian.vercel.app`).

#### 2.4.1 Cas 1: Connexion Directe (MCP distants publics)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION - CONNEXION DIRECTE (MCP distants)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Figma Server   â”‚
â”‚  (user)      â”‚         â”‚   (prod)     â”‚         â”‚   (URL publique)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  1. POST /api/chat     â”‚                            â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
       â”‚  Host: app.vercel.app  â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚  Body:                 â”‚                            â”‚
       â”‚  figmaMcpUrl:          â”‚                            â”‚
       â”‚  https://mcp.          â”‚                            â”‚
       â”‚  figma.com/mcp         â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (connexion directe)     â”‚
       â”‚                        â”‚    OAuth si activÃ©         â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Code Server    â”‚
â”‚  (user)      â”‚         â”‚   (prod)     â”‚         â”‚   (URL publique)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  Body:                 â”‚                            â”‚
       â”‚  codeProjectPath:      â”‚                            â”‚
       â”‚  https://remote.       â”‚                            â”‚
       â”‚  server.com/mcp        â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (connexion directe)     â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
```

#### 2.4.2 Cas 2: Proxy Online (Tunnel Cloudflare)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION - PROXY ONLINE (Tunnel Cloudflare)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    User's    â”‚
         â”‚   Browser    â”‚
         â”‚  (sur le web)â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  1. POST /api/chat
                â”‚  Host: https://app.vercel.app
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
                â”‚  Headers:
                â”‚  X-MCP-Figma-URL: http://127.0.0.1:3333/mcp
                â”‚  X-MCP-Code-URL:  http://127.0.0.1:3846/mcp
                â”‚
                â”‚  Body:
                â”‚  figmaMcpUrl: https://tunnel.trycloudflare.com/proxy-local/figma/mcp
                â”‚  codeProjectPath: https://tunnel.trycloudflare.com/proxy-local/code/mcp
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Next.js     â”‚
         â”‚  (production)â”‚
         â”‚  sur Vercel  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  2. Connexion SSE vers le tunnel
                â”‚  GET https://tunnel.trycloudflare.com/proxy-local/figma/mcp
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Tunnel     â”‚         â”‚   Proxy Local (dev)          â”‚
         â”‚ Cloudflare   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   http://localhost:3000      â”‚
         â”‚  (public)    â”‚         â”‚   (chez l'utilisateur)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚  3. Forward via header
                                         â”‚  X-MCP-Figma-URL: 127.0.0.1:3333/mcp
                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                         â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  MCP Figma   â”‚
                                  â”‚ localhost:3333â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Next.js     â”‚
         â”‚  (production)â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  2b. Connexion SSE vers le tunnel
                â”‚  GET https://tunnel.trycloudflare.com/proxy-local/code/mcp
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Tunnel     â”‚         â”‚   Proxy Local (dev)          â”‚
         â”‚ Cloudflare   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   http://localhost:3000      â”‚
         â”‚  (public)    â”‚         â”‚   (chez l'utilisateur)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚  3b. Forward via header
                                         â”‚  X-MCP-Code-URL: 127.0.0.1:3846/mcp
                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                         â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  MCP Code    â”‚
                                  â”‚ localhost:3846â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DiffÃ©rence clÃ© avec le dÃ©veloppement:**
- En production, le serveur Next.js est sur Vercel (pas en local), mais le **proxy local tourne toujours chez l'utilisateur** (localhost:3000)
- Le flux est identique : Vercel â†’ Tunnel â†’ Proxy Local â†’ MCP (via headers X-MCP-*-URL)
- Les headers `X-MCP-*-URL` sont envoyÃ©s par le browser et utilisÃ©s par le proxy local

**CaractÃ©ristiques:**
- Le proxy middleware est dÃ©sactivÃ© en production (`if (process.env.NODE_ENV === "production")`)
- **âš ï¸ Proxy Local IMPOSSIBLE** : Une app web dÃ©ployÃ©e ne peut pas se connecter Ã  `localhost` (contrainte CORS/rÃ©seau)
- **âœ… Proxy Online POSSIBLE** : Via tunnels Cloudflare (URLs publiques), le serveur Next.js se connecte directement aux tunnels
- URLs configurÃ©es via variables d'environnement ou saisies manuellement
- Connexion directe du serveur Next.js aux MCP distants (URLs publiques)
- OAuth Figma optionnel supportÃ©

**Modes disponibles en production:**

| Mode | Disponible | Commentaire |
|------|------------|-------------|
| Direct | âœ… Oui | Connexion Ã  des MCP distants publics |
| Proxy Local | âŒ Non | `http://localhost` inaccessible depuis le web |
| Proxy Online | âœ… Oui | Via tunnels Cloudflare (ex: `https://xxx.trycloudflare.com`) |

**Paths utilisÃ©s Ã  chaque Ã©tape:**

| Ã‰tape | Source | Destination | Path | Description |
|-------|--------|-------------|------|-------------|
| 1 | Browser | Next.js | `/api/chat` | Endpoint chat API |
| 2 | Next.js | MCP Figma | `/mcp` | Endpoint MCP Figma distant |
| 2 | Next.js | MCP Code | `/mcp` | Endpoint SSE Code distant |

---

## 3. Configuration via "Configure Proxy" (Popup)

### 3.1 Interface de la popup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configure Proxy                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ”µ Proxy Online (Tunnel)      [Active]              â”‚   â”‚
â”‚  â”‚    https://xxx.trycloudflare.com                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Tunnel URL                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ https://your-tunnel.trycloudflare.com               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸŸ¢ Proxy Local                [Active]              â”‚   â”‚
â”‚  â”‚    http://127.0.0.1:3845/mcp                        â”‚   â”‚
â”‚  â”‚    http://127.0.0.1:3846/mcp                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Local Figma MCP URL                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://127.0.0.1:3845/mcp                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Local Code MCP URL                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://127.0.0.1:3846/mcp                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  Secret                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Cancel     â”‚  â”‚              Save                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LÃ©gende des modes:**
- ğŸ”µ **Proxy Online**: Actif quand Tunnel URL est fournie
- ğŸŸ¢ **Proxy Local**: Actif quand Local URLs sont fournies
- Les deux modes peuvent Ãªtre actifs simultanÃ©ment (tunnel + URLs locales)

### 3.2 Logique de la popup

```typescript
// Cas 1: Tunnel URL fournie â†’ Mode proxy online
if (tunnelUrl.trim()) {
  const baseUrl = tunnelUrl.trim().replace(/\/$/, '');
  setFigmaMcpUrl(`${baseUrl}/proxy-local/figma/mcp`);
  setCodeProjectPath(`${baseUrl}/proxy-local/code/mcp`);
  // Les URLs locales sont conservÃ©es pour envoyer les headers X-MCP-*-URL
}

// Cas 2: Pas de tunnel mais URLs locales â†’ Mode proxy local
if (!tunnelUrl.trim() && (localFigmaMcpUrl.trim() || localCodeMcpUrl.trim())) {
  if (localFigmaMcpUrl.trim()) {
    setFigmaMcpUrl(process.env.NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP);
  }
  if (localCodeMcpUrl.trim()) {
    setCodeProjectPath(process.env.NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP);
  }
}
```

### 3.3 Comportements selon les champs remplis

| Mode | Tunnel URL | Local Figma URL | Local Code URL | RÃ©sultat Figma | RÃ©sultat Code | Headers envoyÃ©s |
|------|------------|-----------------|----------------|----------------|---------------|-----------------|
| ğŸ”µ Proxy Online | âœ… Fournie | âœ… Fournie | âœ… Fournie | `{tunnel}/proxy-local/figma/mcp` | `{tunnel}/proxy-local/code/mcp` | X-MCP-Figma-URL, X-MCP-Code-URL |
| ğŸ”µ Proxy Online | âœ… Fournie | âŒ Vide | âŒ Vide | `{tunnel}/proxy-local/figma/mcp` | `{tunnel}/proxy-local/code/mcp` | Aucun |
| ğŸŸ¢ Proxy Local | âŒ Vide | âœ… Fournie | âœ… Fournie | `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` | `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP` | X-MCP-Figma-URL, X-MCP-Code-URL |
| âšª Direct | âŒ Vide | âŒ Vide | âŒ Vide | Valeurs actuelles conservÃ©es | Valeurs actuelles conservÃ©es | Aucun |

---

## 4. Headers MCP

### 4.1 Headers envoyÃ©s par le client

| Header | Description | Exemple |
|--------|-------------|---------|
| `X-Auth-Token` | Secret d'authentification | `abc123...` |
| `X-MCP-Figma-URL` | URL du MCP Figma local | `http://127.0.0.1:3845/mcp` |
| `X-MCP-Code-URL` | URL du MCP Code local | `http://127.0.0.1:3846/mcp` |

### 4.2 Utilisation par le proxy

Le proxy (`src/proxy.ts`) utilise `X-MCP-Code-URL` pour dÃ©terminer l'URL cible:

```typescript
function getMcpCodeUrl(request: NextRequest): string | undefined {
  const headerUrl = request.headers.get("X-MCP-Code-URL");
  const envUrl = process.env.NEXT_PUBLIC_LOCAL_MCP_CODE_URL;
  const url = headerUrl || envUrl;
  if (!url) return undefined;
  return url.replace(/\/$/, '');
}
```

**Logique de forwarding:**
- Si l'URL se termine par `/mcp` ou `/sse` â†’ ajoute le `targetPath` (`/mcp` ou `/sse`)
- Si l'URL ne se termine pas par `/mcp` ou `/sse` â†’ forward vers l'URL exacte

---

## 5. Tableau rÃ©capitulatif des diffÃ©rences

| Aspect | Dev Direct | Dev Proxy Local | Dev Proxy Online | Prod Direct | Prod Proxy Online |
|--------|------------|-----------------|------------------|-------------|-------------------|
| **URLs utilisÃ©es** | `NEXT_PUBLIC_LOCAL_MCP_*_URL` | `NEXT_PUBLIC_PROXY_LOCAL_*_MCP` | `{tunnel}/proxy-local/*` | URLs distantes | `{tunnel}/proxy-local/*` |
| **Middleware actif** | Non | Oui (local) | Oui (local) | Non | Oui (local) |
| **Headers X-MCP** | Oui | Oui | Oui | Non | Oui |
| **Auth Token** | Requis | Requis | Requis | Optionnel | Requis |
| **OAuth Figma** | âœ… SupportÃ© | âœ… SupportÃ© | âœ… SupportÃ© | âœ… SupportÃ© | âœ… SupportÃ© |
| **Rewrite Figma** | Non | `next.config.ts` | `next.config.ts` | N/A | `next.config.ts` |
| **Rewrite Code** | Non | `src/proxy.ts` | `src/proxy.ts` | N/A | `src/proxy.ts` |
| **SSE remapping** | Non | Oui (Code) | Oui (Code) | Non | Oui (Code) |
| **Proxy Local** | N/A | âœ… Oui | âœ… Oui | âŒ Non | âœ… Oui (chez user) |

---

## 6. SÃ©curitÃ©

### 6.1 Middleware de protection (src/proxy.ts)

```typescript
// DÃ©sactivÃ© en production
if (process.env.NODE_ENV === "production") {
  return NextResponse.next();
}

// VÃ©rification du secret pour toutes les requÃªtes
const expectedSecret = process.env.NEXT_PUBLIC_MCP_TUNNEL_SECRET;
const providedSecret = request.headers.get("X-Auth-Token");

if (providedSecret !== expectedSecret) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

### 6.2 Routes publiques (exclues de l'auth)

```typescript
const PUBLIC_AUTH_ROUTES = [
  "/api/auth/figma-mcp",
  "/api/auth/figma-mcp/callback",
  "/api/auth/figma-mcp/register",
  "/api/auth/figma-mcp/status",
];
```

---

## 7. DÃ©pannage

### ProblÃ¨mes courants

| SymptÃ´me | Cause probable | Solution |
|----------|---------------|----------|
| `Unauthorized` | Secret invalide/manquant | VÃ©rifier `NEXT_PUBLIC_MCP_TUNNEL_SECRET` |
| `Connection refused` | MCP server non dÃ©marrÃ© | DÃ©marrer les serveurs MCP locaux |
| `Cannot POST /xxx` | URL incorrecte | VÃ©rifier que l'URL se termine par `/mcp` |
| OAuth Ã©choue | Redirect URI mismatch | VÃ©rifier `NEXT_PUBLIC_BASE_URL` |
| SSE ne charge pas | URL mal remappÃ©e | VÃ©rifier le middleware proxy |
| Tunnel timeout | Cloudflare inactive | VÃ©rifier le tunnel Cloudflare |

---

## 8. Fichiers clÃ©s

| Fichier | RÃ´le |
|---------|------|
| `src/proxy.ts` | Middleware de proxy et auth |
| `src/app/page.tsx` | UI et logique de configuration |
| `src/app/api/chat/route.ts` | Connexion MCP cÃ´tÃ© serveur |
| `src/lib/figma-mcp-oauth.ts` | Gestion OAuth Figma |
| `next.config.ts` | Rewrites Next.js |
| `.env.local` / `.env.example` | Configuration des URLs |
