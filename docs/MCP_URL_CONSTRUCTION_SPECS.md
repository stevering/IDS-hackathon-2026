# Specifications â€” MCP URL Construction (Figma & Code Editor)

## Overview

This document describes the complete URL construction logic for accessing the Figma and Code Editor MCP (Model Context Protocol) servers, in both development and production environments, with and without a proxy.

---

## 1. Environment Variables

### Variables used

| Variable | Description | Example |
|----------|-------------|---------|
| `NODE_ENV` | Runtime mode | `development` / `production` |
| `NEXT_PUBLIC_LOCAL_MCP_FIGMA_URL` | Direct URL to the local Figma MCP | `http://127.0.0.1:3845/mcp` |
| `NEXT_PUBLIC_LOCAL_MCP_CODE_URL` | Direct URL to the local Code MCP | `http://127.0.0.1:3846/mcp` |
| `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` | Proxy URL for Figma | `http://localhost:3000/proxy-local/figma/mcp` |
| `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP` | Proxy URL for Code | `http://localhost:3000/proxy-local/code/mcp` |
| `NEXT_PUBLIC_MCP_TUNNEL_SECRET` | Proxy/tunnel authentication secret (middleware only) | Randomly generated token |
| `NEXT_PUBLIC_BASE_URL` | Application base URL | `http://127.0.0.1:3000` |
| `FIGMA_ACCESS_TOKEN` | Figma access token (optional) | `figd_xxxxx` |
| `FIGMA_CLIENT_ID` | Figma OAuth client ID (optional) | `xxxxx` |
| `FIGMA_CLIENT_SECRET` | Figma OAuth client secret (optional) | `xxxxx` |

> **Note:** `NEXT_PUBLIC_MCP_TUNNEL_SECRET` is **not** used as the key for the Southleft OAuth store. The store key is an **ephemeral session key** generated by the client on each connection attempt (see section 9).

---

## 2. Connection Flow Architecture

### 2.1 Development Mode â€” Direct (no proxy)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DEVELOPMENT MODE â€” DIRECT (NO PROXY)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Figma Server   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚    (port 3845)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  1. POST /api/chat     â”‚                            â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚  Headers:              â”‚                            â”‚
       â”‚  X-Auth-Token: secret  â”‚                            â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                            â”‚
       â”‚    http://127.0.0.1:   â”‚                            â”‚
       â”‚    3845/mcp            â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚    to: 127.0.0.1:3845/mcp  â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
       â”‚                        â”‚                            â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Code Server    â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚    (port 3846)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  Headers:              â”‚                            â”‚
       â”‚  X-Auth-Token: secret  â”‚                            â”‚
       â”‚  X-MCP-Code-URL:       â”‚                            â”‚
       â”‚    http://127.0.0.1:   â”‚                            â”‚
       â”‚    3846/mcp            â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚    to: 127.0.0.1:3846/mcp  â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
```

**Characteristics:**
- Direct connection from the Next.js server to local MCPs
- URLs used: `NEXT_PUBLIC_LOCAL_MCP_FIGMA_URL` and `NEXT_PUBLIC_LOCAL_MCP_CODE_URL`
- Authentication via `X-Auth-Token` header
- URLs are passed via `X-MCP-Figma-URL` and `X-MCP-Code-URL` headers

---

### 2.2 Development Mode â€” Local Proxy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DEVELOPMENT MODE â€” LOCAL PROXY                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Figma  â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3845)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  1. POST /api/chat     â”‚                        â”‚                        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  figmaMcpUrl:          â”‚                        â”‚                        â”‚
       â”‚    http://localhost:   â”‚                        â”‚                        â”‚
       â”‚    3000/proxy-local/   â”‚                        â”‚                        â”‚
       â”‚    figma/mcp           â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3845/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET /proxy-local/  â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    figma/mcp           â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3845  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Figma-   â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  4. Response           â”‚
       â”‚                        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  5. Modified response  â”‚                        â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚
       â”‚                        â”‚    (URLs remapped)     â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  6. Stream to client   â”‚                        â”‚                        â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚                        â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Code   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3846)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  codeProjectPath:      â”‚                        â”‚                        â”‚
       â”‚    http://localhost:   â”‚                        â”‚                        â”‚
       â”‚    3000/proxy-local/   â”‚                        â”‚                        â”‚
       â”‚    code/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Code-URL:       â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3846/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET /proxy-local/  â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    code/mcp            â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3846  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Code-    â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  4. Response           â”‚
       â”‚                        â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  5. SSE stream         â”‚                        â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                        â”‚
       â”‚                        â”‚    (URLs remapped)     â”‚                        â”‚
```

**Characteristics:**
- The proxy middleware (`src/proxy.ts`) intercepts `/proxy-local/*` requests
- For Figma: uses Next.js rewrites defined in `next.config.ts`
- For Code: uses the custom middleware that also handles URL remapping in SSE responses
- URLs used: `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` and `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP`
- The `X-MCP-Code-URL` header is used by the proxy to determine the target URL:
  - Example: if `X-MCP-Code-URL: http://127.0.0.1:3846/mcp`, the proxy forwards to `http://127.0.0.1:3846/mcp`
  - If the URL does not end with `/mcp` or `/sse` (e.g. `/mcp3`), the proxy forwards to the exact URL without appending a path
  - If no header is present, falls back to `NEXT_PUBLIC_LOCAL_MCP_CODE_URL` from environment variables

---

### 2.3 Development Mode â€” Online Proxy (Tunnel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEVELOPMENT MODE â€” ONLINE PROXY (TUNNEL)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Figma  â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3845)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  1. POST /api/chat     â”‚                        â”‚                        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  figmaMcpUrl:          â”‚                        â”‚                        â”‚
       â”‚    https://tunnel.     â”‚                        â”‚                        â”‚
       â”‚    trycloudflare.com/  â”‚                        â”‚                        â”‚
       â”‚    proxy-local/        â”‚                        â”‚                        â”‚
       â”‚    figma/mcp           â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Figma-URL:      â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3845/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET https://tunnel â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    .trycloudflare.com/ â”‚                        â”‚
       â”‚                        â”‚    proxy-local/figma/  â”‚                        â”‚
       â”‚                        â”‚    mcp                 â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3845  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Figma-   â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   Middleware â”‚         â”‚   MCP Code   â”‚
â”‚  (localhost) â”‚         â”‚   (dev:3000) â”‚         â”‚   Proxy      â”‚         â”‚   (port 3846)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Body:                 â”‚                        â”‚                        â”‚
       â”‚  codeProjectPath:      â”‚                        â”‚                        â”‚
       â”‚    https://tunnel.     â”‚                        â”‚                        â”‚
       â”‚    trycloudflare.com/  â”‚                        â”‚                        â”‚
       â”‚    proxy-local/code/   â”‚                        â”‚                        â”‚
       â”‚    mcp                 â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚  Headers:              â”‚                        â”‚                        â”‚
       â”‚  X-MCP-Code-URL:       â”‚                        â”‚                        â”‚
       â”‚    http://127.0.0.1:   â”‚                        â”‚                        â”‚
       â”‚    3846/mcp            â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚  2. GET https://tunnel â”‚                        â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                        â”‚
       â”‚                        â”‚    .trycloudflare.com/ â”‚                        â”‚
       â”‚                        â”‚    proxy-local/code/   â”‚                        â”‚
       â”‚                        â”‚    mcp                 â”‚                        â”‚
       â”‚                        â”‚                        â”‚                        â”‚
       â”‚                        â”‚                        â”‚  3. Forward /mcp       â”‚
       â”‚                        â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚                        â”‚    to: 127.0.0.1:3846  â”‚
       â”‚                        â”‚                        â”‚    (via X-MCP-Code-    â”‚
       â”‚                        â”‚                        â”‚     URL header)        â”‚
```

**Characteristics:**
- Uses a Cloudflare tunnel (or similar) to expose the local proxy
- The browser connects to the tunnel, which forwards to the local proxy
- The local proxy uses `X-MCP-*-URL` headers to forward to local MCPs
- Both modes (Online Proxy and Local Proxy) can be active simultaneously
- URLs used: `{tunnel}/proxy-local/figma/mcp` and `{tunnel}/proxy-local/code/mcp`

---

### 2.4 Production Mode

In production, the application is deployed at a remote URL (e.g. `https://ids-hackathon-2026-ds-ai-guardian.vercel.app`).

#### 2.4.1 Case 1: Direct Connection (public remote MCPs)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION â€” DIRECT CONNECTION (remote MCPs)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Figma Server   â”‚
â”‚  (user)      â”‚         â”‚   (prod)     â”‚         â”‚   (public URL)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  1. POST /api/chat     â”‚                            â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚                            â”‚
       â”‚  Host: app.vercel.app  â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚  Body:                 â”‚                            â”‚
       â”‚  figmaMcpUrl:          â”‚                            â”‚
       â”‚  https://mcp.          â”‚                            â”‚
       â”‚  figma.com/mcp         â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚    OAuth if enabled        â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚         â”‚   Next.js    â”‚         â”‚   MCP Code Server    â”‚
â”‚  (user)      â”‚         â”‚   (prod)     â”‚         â”‚   (public URL)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                            â”‚
       â”‚  Body:                 â”‚                            â”‚
       â”‚  codeProjectPath:      â”‚                            â”‚
       â”‚  https://remote.       â”‚                            â”‚
       â”‚  server.com/mcp        â”‚                            â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  2. GET /mcp               â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
       â”‚                        â”‚    (direct connection)     â”‚
       â”‚                        â”‚                            â”‚
       â”‚                        â”‚  3. Tools response         â”‚
       â”‚                        â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
       â”‚                        â”‚                            â”‚
       â”‚  4. Stream response    â”‚                            â”‚
       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            â”‚
```

#### 2.4.2 Case 2: Online Proxy (Cloudflare Tunnel)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PRODUCTION â€” ONLINE PROXY (Cloudflare Tunnel)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    User's    â”‚
         â”‚   Browser    â”‚
         â”‚  (on the web)â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  1. POST /api/chat
                â”‚  Host: https://app.vercel.app
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
                â”‚  Headers:
                â”‚  X-MCP-Figma-URL: http://127.0.0.1:3333/mcp
                â”‚  X-MCP-Code-URL:  http://127.0.0.1:3846/mcp
                â”‚
                â”‚  Body:
                â”‚  figmaMcpUrl: https://tunnel.trycloudflare.com/proxy-local/figma/mcp
                â”‚  codeProjectPath: https://tunnel.trycloudflare.com/proxy-local/code/mcp
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Next.js     â”‚
         â”‚  (production)â”‚
         â”‚  on Vercel   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  2. SSE connection to tunnel
                â”‚  GET https://tunnel.trycloudflare.com/proxy-local/figma/mcp
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Tunnel     â”‚         â”‚   Local Proxy (dev)          â”‚
         â”‚ Cloudflare   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   http://localhost:3000      â”‚
         â”‚  (public)    â”‚         â”‚   (at user's machine)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚  3. Forward via header
                                         â”‚  X-MCP-Figma-URL: 127.0.0.1:3333/mcp
                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                         â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  MCP Figma   â”‚
                                  â”‚ localhost:3333â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Next.js     â”‚
         â”‚  (production)â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚  2b. SSE connection to tunnel
                â”‚  GET https://tunnel.trycloudflare.com/proxy-local/code/mcp
                â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Tunnel     â”‚         â”‚   Local Proxy (dev)          â”‚
         â”‚ Cloudflare   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   http://localhost:3000      â”‚
         â”‚  (public)    â”‚         â”‚   (at user's machine)        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â”‚  3b. Forward via header
                                         â”‚  X-MCP-Code-URL: 127.0.0.1:3846/mcp
                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                         â”‚
                                  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  MCP Code    â”‚
                                  â”‚ localhost:3846â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key difference from development:**
- In production, the Next.js server runs on Vercel (not locally), but the **local proxy always runs at the user's machine** (localhost:3000)
- The flow is identical: Vercel â†’ Tunnel â†’ Local Proxy â†’ MCP (via `X-MCP-*-URL` headers)
- The `X-MCP-*-URL` headers are sent by the browser and used by the local proxy

**Characteristics:**
- The proxy middleware is disabled in production (`if (process.env.NODE_ENV === "production")`)
- **âš ï¸ Local Proxy IMPOSSIBLE**: A deployed web app cannot connect to `localhost` (CORS/network constraint)
- **âœ… Online Proxy POSSIBLE**: Via Cloudflare tunnels (public URLs), the Next.js server connects directly to the tunnels
- URLs configured via environment variables or entered manually
- Direct connection from Next.js server to remote MCPs (public URLs)
- Optional Figma OAuth supported

**Available modes in production:**

| Mode | Available | Notes |
|------|-----------|-------|
| Direct | âœ… Yes | Connection to public remote MCPs |
| Local Proxy | âŒ No | `http://localhost` not reachable from the web |
| Online Proxy | âœ… Yes | Via Cloudflare tunnels (e.g. `https://xxx.trycloudflare.com`) |

**Paths used at each step:**

| Step | Source | Destination | Path | Description |
|------|--------|-------------|------|-------------|
| 1 | Browser | Next.js | `/api/chat` | Chat API endpoint |
| 2 | Next.js | MCP Figma | `/mcp` | Remote Figma MCP endpoint |
| 2 | Next.js | MCP Code | `/mcp` | Remote Code SSE endpoint |

---

## 3. Configuration via "Configure Proxy" (Modal)

### 3.1 Modal interface

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Configure Proxy                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ðŸ”µ Proxy Online (Tunnel)      [Active]              â”‚   â”‚
â”‚  â”‚    https://xxx.trycloudflare.com                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Tunnel URL                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ https://your-tunnel.trycloudflare.com               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ðŸŸ¢ Proxy Local                [Active]              â”‚   â”‚
â”‚  â”‚    http://127.0.0.1:3845/mcp                        â”‚   â”‚
â”‚  â”‚    http://127.0.0.1:3846/mcp                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Local Figma MCP URL                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://127.0.0.1:3845/mcp                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Local Code MCP URL                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ http://127.0.0.1:3846/mcp                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  Secret                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Cancel     â”‚  â”‚              Save                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mode legend:**
- ðŸ”µ **Proxy Online**: Active when a Tunnel URL is provided
- ðŸŸ¢ **Proxy Local**: Active when Local URLs are provided
- Both modes can be active simultaneously (tunnel + local URLs)

### 3.2 Modal logic

```typescript
// Case 1: Tunnel URL provided â†’ Online proxy mode
if (tunnelUrl.trim()) {
  const baseUrl = tunnelUrl.trim().replace(/\/$/, '');
  setFigmaMcpUrl(`${baseUrl}/proxy-local/figma/mcp`);
  setCodeProjectPath(`${baseUrl}/proxy-local/code/mcp`);
  // Local URLs are kept to send X-MCP-*-URL headers
}

// Case 2: No tunnel but local URLs â†’ Local proxy mode
if (!tunnelUrl.trim() && (localFigmaMcpUrl.trim() || localCodeMcpUrl.trim())) {
  if (localFigmaMcpUrl.trim()) {
    setFigmaMcpUrl(process.env.NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP);
  }
  if (localCodeMcpUrl.trim()) {
    setCodeProjectPath(process.env.NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP);
  }
}
```

### 3.3 Behaviour based on filled fields

| Mode | Tunnel URL | Local Figma URL | Local Code URL | Figma result | Code result | Headers sent |
|------|------------|-----------------|----------------|--------------|-------------|--------------|
| ðŸ”µ Proxy Online | âœ… Provided | âœ… Provided | âœ… Provided | `{tunnel}/proxy-local/figma/mcp` | `{tunnel}/proxy-local/code/mcp` | X-MCP-Figma-URL, X-MCP-Code-URL |
| ðŸ”µ Proxy Online | âœ… Provided | âŒ Empty | âŒ Empty | `{tunnel}/proxy-local/figma/mcp` | `{tunnel}/proxy-local/code/mcp` | None |
| ðŸŸ¢ Proxy Local | âŒ Empty | âœ… Provided | âœ… Provided | `NEXT_PUBLIC_PROXY_LOCAL_FIGMA_MCP` | `NEXT_PUBLIC_PROXY_LOCAL_CODE_MCP` | X-MCP-Figma-URL, X-MCP-Code-URL |
| âšª Direct | âŒ Empty | âŒ Empty | âŒ Empty | Current values kept | Current values kept | None |

---

## 4. MCP Headers

### 4.1 Headers sent by the client

| Header | Description | Example |
|--------|-------------|---------|
| `X-Auth-Token` | Authentication secret | `abc123...` |
| `X-MCP-Figma-URL` | Local Figma MCP URL | `http://127.0.0.1:3845/mcp` |
| `X-MCP-Code-URL` | Local Code MCP URL | `http://127.0.0.1:3846/mcp` |

### 4.2 Usage by the proxy

The proxy (`src/proxy.ts`) uses `X-MCP-Code-URL` to determine the target URL:

```typescript
function getMcpCodeUrl(request: NextRequest): string | undefined {
  const headerUrl = request.headers.get("X-MCP-Code-URL");
  const envUrl = process.env.NEXT_PUBLIC_LOCAL_MCP_CODE_URL;
  const url = headerUrl || envUrl;
  if (!url) return undefined;
  return url.replace(/\/$/, '');
}
```

**Forwarding logic:**
- If the URL ends with `/mcp` or `/sse` â†’ appends the `targetPath` (`/mcp` or `/sse`)
- If the URL does not end with `/mcp` or `/sse` â†’ forwards to the exact URL as-is

---

## 5. Comparison Table

| Aspect | Dev Direct | Dev Local Proxy | Dev Online Proxy | Prod Direct | Prod Online Proxy |
|--------|------------|-----------------|------------------|-------------|-------------------|
| **URLs used** | `NEXT_PUBLIC_LOCAL_MCP_*_URL` | `NEXT_PUBLIC_PROXY_LOCAL_*_MCP` | `{tunnel}/proxy-local/*` | Remote URLs | `{tunnel}/proxy-local/*` |
| **Middleware active** | No | Yes (local) | Yes (local) | No | Yes (local) |
| **X-MCP headers** | Yes | Yes | Yes | No | Yes |
| **Auth Token** | Required | Required | Required | Optional | Required |
| **Figma OAuth** | âœ… Supported | âœ… Supported | âœ… Supported | âœ… Supported | âœ… Supported |
| **Figma rewrite** | No | `next.config.ts` | `next.config.ts` | N/A | `next.config.ts` |
| **Code rewrite** | No | `src/proxy.ts` | `src/proxy.ts` | N/A | `src/proxy.ts` |
| **SSE remapping** | No | Yes (Code) | Yes (Code) | No | Yes (Code) |
| **Local Proxy** | N/A | âœ… Yes | âœ… Yes | âŒ No | âœ… Yes (at user's machine) |

---

## 6. Security

### 6.1 Protection middleware (src/proxy.ts)

```typescript
// Disabled in production
if (process.env.NODE_ENV === "production") {
  return NextResponse.next();
}

// Secret check for all requests
const expectedSecret = process.env.NEXT_PUBLIC_MCP_TUNNEL_SECRET;
const providedSecret = request.headers.get("X-Auth-Token");

if (providedSecret !== expectedSecret) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

### 6.2 Public routes (excluded from auth)

```typescript
const PUBLIC_AUTH_ROUTES = [
  "/api/auth/figma-mcp",
  "/api/auth/figma-mcp/callback",
  "/api/auth/figma-mcp/register",
  "/api/auth/figma-mcp/status",
  "/api/auth/southleft-mcp",
  "/api/auth/southleft-mcp/callback",
  "/api/auth/southleft-mcp/status",
  "/api/auth/southleft-mcp/disconnect",
  "/api/set-oauth-result",
];
```

---

## 7. Troubleshooting

### Common issues

| Symptom | Likely cause | Fix |
|---------|--------------|-----|
| `Unauthorized` | Invalid or missing secret | Check `NEXT_PUBLIC_MCP_TUNNEL_SECRET` |
| `Connection refused` | MCP server not running | Start the local MCP servers |
| `Cannot POST /xxx` | Incorrect URL | Ensure the URL ends with `/mcp` |
| OAuth fails | Redirect URI mismatch | Check `NEXT_PUBLIC_BASE_URL` |
| SSE not loading | URL not remapped correctly | Check the proxy middleware |
| Tunnel timeout | Cloudflare tunnel inactive | Check the Cloudflare tunnel |
| Southleft polling always `null` | Missing session key | Key is generated on click â€” verify `oauthSessionRef.current` is passed as a query param |
| Southleft popup does not close | External navigation (Southleft OAuth) revokes `window.close()` right | Expected behaviour â€” `/southleft-auth-success.html` shows "you can close this tab" |
| Southleft re-auth without prompt | httpOnly cookies still present after disconnect | Verify `/api/auth/southleft-mcp/disconnect` is called and returns `ok: true` |
| `Invalid state` at Southleft callback | `southleft_mcp_state` cookie expired or domain mismatch | Check `NEXT_PUBLIC_BASE_URL` and canonical domain consistency |

---

## 8. Key Files

| File | Role |
|------|------|
| `src/proxy.ts` | Proxy and auth middleware |
| `src/app/page.tsx` | UI and configuration logic |
| `src/app/api/chat/route.ts` | Server-side MCP connection |
| `src/lib/figma-mcp-oauth.ts` | Figma MCP OAuth handling |
| `src/lib/southleft-mcp-oauth.ts` | Southleft OAuth provider (cookies, tokens) |
| `src/lib/oauth-store.ts` | Shared in-memory store for OAuth token relay |
| `src/app/api/auth/southleft-mcp/route.ts` | Southleft OAuth flow initiation |
| `src/app/api/auth/southleft-mcp/callback/route.ts` | Southleft OAuth callback |
| `src/app/api/auth/southleft-mcp/disconnect/route.ts` | Disconnect (expires httpOnly cookies) |
| `src/app/api/set-oauth-result/route.ts` | GET/POST relay for Figma plugin polling |
| `public/southleft-auth-success.html` | OAuth success page (lightweight popup) |
| `next.config.ts` | Next.js rewrites |
| `.env.local` / `.env.example` | URL configuration |

---

## 9. Figma Console MCP OAuth (Southleft)

### 9.1 Overview

The **Figma Console MCP** is a third-party MCP server operated by Southleft (`https://figma-console-mcp.southleft.com`). It exposes Figma tools via OAuth 2.0 (PKCE, no `client_secret`). It does **not** provide a token revocation endpoint (RFC 7009 not implemented) â€” disconnection is therefore purely local (cookie expiry).

**Discovery document:** `https://figma-console-mcp.southleft.com/.well-known/oauth-authorization-server`

```json
{
  "authorization_endpoint": "https://figma-console-mcp.southleft.com/authorize",
  "token_endpoint":         "https://figma-console-mcp.southleft.com/token",
  "registration_endpoint":  "https://figma-console-mcp.southleft.com/oauth/register",
  "scopes_supported":       ["file_content:read", "library_content:read", "file_variables:read"]
}
```

### 9.2 Session key mechanism (popup â†’ plugin relay)

The core challenge is relaying the OAuth token obtained in an **external popup** (Chrome) back to the Figma plugin's **iframe**, without a shared env var and without being able to programmatically close the popup after an OAuth navigation.

**Solution: ephemeral session key**

```
[page.tsx - Figma iframe]
  1. Generates session = "x7f3k9" (random, per attempt)
  2. Stores in oauthSessionRef.current
  3. Opens popup /api/auth/southleft-mcp?session=x7f3k9
  4. Starts polling GET /api/set-oauth-result (X-Auth-Token: x7f3k9) every 2s

[Server - initiation route]
  5. Reads session="x7f3k9" from query param
  6. Stores in httpOnly cookie southleft_oauth_session (TTL 10min)

[Popup - Southleft OAuth]
  7. Redirect â†’ Southleft /authorize â†’ user authorises â†’ redirect to callback

[Server - callback]
  8. Reads southleft_oauth_session cookie â†’ session="x7f3k9"
  9. Exchanges code â†’ tokens via auth()
  10. writeOAuthResult("x7f3k9", { access_token, ... })  â† direct, synchronous
  11. Deletes southleft_oauth_session cookie
  12. Returns HTML â†’ setLocalStorage â†’ redirect /southleft-auth-success.html

[page.tsx - polling]
  13. GET /api/set-oauth-result (X-Auth-Token: x7f3k9)
  14. readOAuthResult("x7f3k9") â†’ token found âœ…
  15. setSouthleftOAuth(true), setWaitingForOAuth(false)
```

**Why not `NEXT_PUBLIC_MCP_TUNNEL_SECRET`?**
This variable is not necessarily defined (absent from `.env.local` by default). If `undefined` on the client, the polling sends no header â†’ `401`. The ephemeral session key removes this dependency entirely.

**Store lifecycle (`src/lib/oauth-store.ts`):**
- Write: synchronous in the callback, before `return response`
- Read: consumes the entry (deletes after reading), TTL 60s
- Multi-server production: replace with Redis/Vercel KV (`writeOAuthResult` / `readOAuthResult` are the only two touch points)

---

### 9.3 Scenario A â€” Standalone mode, not previously connected

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STANDALONE MODE â€” NOT PREVIOUSLY CONNECTED                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome           â”‚      â”‚  Next.js          â”‚      â”‚  Southleft           â”‚
â”‚  page.tsx         â”‚      â”‚  :3000            â”‚      â”‚  figma-console-mcp   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                             â”‚
         â”‚  click "Sign in"         â”‚                             â”‚
         â”‚  session="x7f3k9"        â”‚                             â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                             â”‚
         â”‚  GET /api/auth/southleft-mcp?session=x7f3k9            â”‚
         â”‚  (Chrome popup)          â”‚                             â”‚
         â”‚                          â”‚                             â”‚
         â”‚                     auth() â†’ no tokens in cookies      â”‚
         â”‚                     â†’ set cookie southleft_oauth_session=x7f3k9
         â”‚                          â”‚  307 â†’ /authorize?...       â”‚
         â”‚                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                          â”‚                             â”‚
         â”‚                          â”‚            user authorises  â”‚
         â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚  GET /api/auth/southleft-mcp/callback?code=...&state=..â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                             â”‚
         â”‚                          â”‚                             â”‚
         â”‚                     reads cookie southleft_oauth_session â†’ x7f3k9
         â”‚                     auth(code) â†’ tokens
         â”‚                     writeOAuthResult("x7f3k9", {access_token})
         â”‚                     delete cookies: state, code_verifier, session
         â”‚                          â”‚                             â”‚
         â”‚  HTML (set localStorage) â”‚                             â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
         â”‚  redirect â†’ /southleft-auth-success.html               â”‚
         â”‚                          â”‚                             â”‚
         â”‚  [polling] GET /api/set-oauth-result                   â”‚
         â”‚  X-Auth-Token: x7f3k9    â”‚                             â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                             â”‚
         â”‚                     readOAuthResult("x7f3k9") â†’ token  â”‚
         â”‚  { access_token: "..." } â”‚                             â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
         â”‚                          â”‚                             â”‚
         â”‚  setSouthleftOAuth(true) âœ…                             â”‚
```

**Final state:**
- `southleft_access_token` in Chrome localStorage
- httpOnly cookies: `southleft_mcp_tokens`, `southleft_mcp_client_info`
- "Connected via OAuth" button visible

---

### 9.4 Scenario B â€” Standalone mode, already connected

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STANDALONE MODE â€” ALREADY CONNECTED (valid tokens in cookie)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chrome           â”‚      â”‚  Next.js          â”‚
â”‚  page.tsx         â”‚      â”‚  :3000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚
         â”‚  click "Sign in"         â”‚
         â”‚  session="y9m2p1"        â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚  GET /api/auth/southleft-mcp?session=y9m2p1
         â”‚  (Chrome popup)          â”‚
         â”‚                          â”‚
         â”‚                     auth() â†’ valid tokens in cookie â†’ immediate success
         â”‚                     provider.tokens() â†’ { access_token: "..." }
         â”‚                     writeOAuthResult("y9m2p1", { access_token })
         â”‚                          â”‚
         â”‚  307 â†’ /southleft-auth-success.html
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                          â”‚
         â”‚  success.html:           â”‚
         â”‚  â€¢ postMessage to opener (may fail depending on context)
         â”‚  â€¢ window.close() â† SUCCESS (no external navigation)
         â”‚  popup closes automatically âœ…
         â”‚                          â”‚
         â”‚  [polling] GET /api/set-oauth-result
         â”‚  X-Auth-Token: y9m2p1    â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                     readOAuthResult("y9m2p1") â†’ token
         â”‚  { access_token: "..." } â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                          â”‚
         â”‚  setSouthleftOAuth(true) âœ…
```

**Key difference from Scenario A:** `auth()` succeeds immediately (tokens in cookies) â†’ no redirect to Southleft â†’ `window.close()` works (the popup has not navigated outside `localhost:3000`).

---

### 9.5 Scenario C â€” Figma plugin mode, not previously connected

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIGMA PLUGIN MODE â€” NOT PREVIOUSLY CONNECTED                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Figma Desktop    â”‚   â”‚  iframe           â”‚   â”‚  Chrome external  â”‚   â”‚  Next.js          â”‚
â”‚  (Electron)       â”‚   â”‚  localhost:3000   â”‚   â”‚  (OAuth popup)    â”‚   â”‚  :3000            â”‚
â”‚  ui.html          â”‚   â”‚  page.tsx         â”‚   â”‚                   â”‚   â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚  loads iframe         â”‚                        â”‚                          â”‚
         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                          â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              click "Sign in"                   â”‚                          â”‚
         â”‚              session="z4k8r2"                  â”‚                          â”‚
         â”‚              oauthSessionRef.current="z4k8r2"  â”‚                          â”‚
         â”‚              window.open â†’ popup in Chrome     â”‚                          â”‚
         â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                       â”‚  GET /api/auth/southleft-mcp?session=z4k8r2       â”‚
         â”‚              setWaitingForOAuth(true)           â”‚                          â”‚
         â”‚              polling starts (X-Auth-Token: z4k8r2)                        â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚                        â”‚   307 â†’ Southleft /authorize
         â”‚                       â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚              user authorises in Chrome            â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚                        â”‚  GET /api/auth/southleft-mcp/callback
         â”‚                       â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚                        â”‚   auth(code) â†’ tokens    â”‚
         â”‚                       â”‚                        â”‚   writeOAuthResult("z4k8r2", token)
         â”‚                       â”‚                        â”‚   HTML â†’ localStorage    â”‚
         â”‚                       â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚              redirect â†’ /southleft-auth-success.html
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚              postMessage opener â†’ FAILS           â”‚
         â”‚                       â”‚              (opener = Electron iframe, unreachable from Chrome)
         â”‚                       â”‚              window.close() â†’ FAILS              â”‚
         â”‚                       â”‚              (external navigation revokes the right)
         â”‚                       â”‚              shows "You can close this tab" âœ…    â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              [polling] GET /api/set-oauth-result (X-Auth-Token: z4k8r2)  â”‚
         â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                       â”‚              readOAuthResult("z4k8r2") â†’ token   â”‚
         â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              setSouthleftOAuth(true) âœ…         â”‚                          â”‚
```

**Plugin mode specifics:**
- The popup opens in **external Chrome** (not in the Electron webview)
- `window.opener` in the popup does **not** point to the Figma iframe â†’ `postMessage` fails silently
- `window.close()` fails: the popup navigated to Southleft (external domain) â†’ Chrome revokes the automatic close right
- **Polling** is the only reliable mechanism â†’ it works thanks to the synchronous `writeOAuthResult` in the callback

---

### 9.6 Scenario D â€” Figma plugin mode, already connected

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIGMA PLUGIN MODE â€” ALREADY CONNECTED (tokens in Chrome cookie)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Figma Desktop    â”‚   â”‚  iframe           â”‚   â”‚  Chrome external  â”‚   â”‚  Next.js          â”‚
â”‚  (Electron)       â”‚   â”‚  localhost:3000   â”‚   â”‚  (OAuth popup)    â”‚   â”‚  :3000            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              click "Sign in"                   â”‚                          â”‚
         â”‚              session="w1n5q7"                  â”‚                          â”‚
         â”‚              window.open â†’ popup in Chrome     â”‚                          â”‚
         â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                       â”‚  GET /api/auth/southleft-mcp?session=w1n5q7       â”‚
         â”‚              setWaitingForOAuth(true)           â”‚                          â”‚
         â”‚              polling starts (X-Auth-Token: w1n5q7)                        â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚                   auth() â†’ valid tokens in Chrome cookie
         â”‚                       â”‚                   writeOAuthResult("w1n5q7", { access_token })
         â”‚                       â”‚                        â”‚   307 â†’ /southleft-auth-success.html
         â”‚                       â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚                       â”‚              window.close() â†’ SUCCESS âœ…          â”‚
         â”‚                       â”‚              (no external navigation)             â”‚
         â”‚                       â”‚              popup closes automatically âœ…        â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              [polling] GET /api/set-oauth-result (X-Auth-Token: w1n5q7)  â”‚
         â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                       â”‚              readOAuthResult("w1n5q7") â†’ token   â”‚
         â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
         â”‚                       â”‚                        â”‚                          â”‚
         â”‚              setSouthleftOAuth(true) âœ…         â”‚                          â”‚
```

**Difference from Scenario C:** `auth()` succeeds directly in the initiation route (valid Chrome tokens) â†’ no redirect to Southleft â†’ `window.close()` works.

---

### 9.7 Disconnection

```
[page.tsx] click "Disconnect"
  â†’ POST /api/auth/southleft-mcp/disconnect
      â†’ expires httpOnly cookies:
          southleft_mcp_tokens, southleft_mcp_client_info,
          southleft_mcp_code_verifier, southleft_mcp_state
      â†’ { ok: true }
  â†’ localStorage.removeItem('southleft_access_token')
  â†’ setSouthleftOAuth(false)
```

> **Note:** Southleft does not provide an OAuth revocation endpoint (RFC 7009). Disconnection is local only. The next OAuth flow will prompt for re-authorisation since the cookies are expired.

### 9.8 Comparison table â€” all 4 scenarios

| | Standalone not connected | Standalone already connected | Plugin not connected | Plugin already connected |
|---|---|---|---|---|
| **External OAuth navigation** | Yes | No | Yes | No |
| **`window.close()` works** | No | Yes | No | Yes |
| **`postMessage` to opener works** | Yes (same process) | Yes | No (cross-process) | No |
| **Relay mechanism** | Polling (fallback) | Polling | Polling (only mechanism) | Polling |
| **Popup closes automatically** | No | Yes | No | Yes |
| **Message shown** | "You can close this tab" | â€” | "You can close this tab" | â€” |
